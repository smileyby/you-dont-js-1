你不知道的JavaScript（上卷）
=========================

## 作用域和闭包

### 作用域是什么

几乎所有的编程语言最基本的功能之一，就是能够存储变量当中的值，并且能在之后对这个值进行访问和修改。事实上，正式这种存储和访问变量的值的能力将状态带给了程序。

若没有了状态这个概念，程序虽然也能够执行一些简单的任务，但它会受到高度限制，做不到非常有趣。

但是将变量引入程序会引起很有意思的问题，也正式我们将要讨论：这些变量住在哪里？换句话说，他们储存在哪里？最重要的是，程序需要时如何找到他们？

这些问题说明需要一套良好的规则来存储变量，并且之后可以方便地找到这些变量。这套规则被称为作用域。

但是究竟在哪里而且怎么设置这些作用域规则呢？

#### 1.1编译原理

尽管通常将JavaScript归类为“动态”或“解释执行”语言，但事实上它是一门编译语言非常相似，在某些环节可能比预想的要复杂。

在传统编译语言的流程中，程序中的一段源代码在执行之前会经历三个步骤，统称为“编译”。

* 分词/词法分析
> 这个过程会将由字符组成的字符串分解成（对编程语言来说）有意义的代码块，这些代码块被称为词法单元（token）。例如，考虑程序`var a = 2;`。这段程序通常会被分解成为下面的词法单元：`var 、 a、 =、 2、 ；`。空格是否会被当做词法单元，取决于空格在这门语言中是否具有意义。

> **分词和词法分析之间的区别是非常微妙、晦涩的，主要差异在于词法单元的识别是通过有状态还是无状态的方式进行的。简单来说，如果词法单元生成器在判断a是一个独立的词法单元还是其他词法单元的一部分时，调用的是有状态的解析规则，那么这个过程就被称为词法分析。**

* 解析/语法分析

> 这个过程是将词法单元流转换为一个由元素逐级嵌套所组成的代表了程序语法结构的树。这个树被称为“抽象语法树”。`var a = 2;`的抽象语法树中可能会有一个叫做VariableDeclaration的顶级节点，接下来是一个叫做Identifier（它的值是a）的子节点，以及一个叫做AssignmentExpression的子节点。AssignmentExpression节点有一个叫做Numericliteral（它的值是2）的子节点。

* 代码生成

> 将AST转换为可执行的代码的过程称为代码生成。这个过程与语言、目标平台等息息相关。
> 
> 抛开具体细节，简单来说就是某种方法可以将`var a = 2;`的AST转化为一组及其指令，用来创建一个叫做a得变量（包括分配内存等），并将一个存储存在a中。
> 
> **关于引擎如何管理系统资源超出了我们的探讨范围，因此只需要简单地了解引擎可以根据需要创建并存储变量即可。**

比起那些辨析过程只有三个步骤的语言编译器，JavaScript引擎要复杂的多。例如，在语法分析和代码生成阶段特定的步骤来对运行性能进行优化，包括冗余元素进行优化等。

因此在这里只进行宏观、简单的介绍，接下来你就会发现我们介绍的这些开起来有点高深的内容与所要讨论的事情有什么关联。

首先，JavaScript引擎不会有大量的（像其他语言编译器那么多）时间用来进行优化，因为与其他语言不同，JavaScript的编译过程不是发生在构建之前的。

对于JavaScript来说，大部分情况下编译发生在代码执行前的几微秒（甚至更短！）的时间内。在我们所要讨论的作用域背后，JavaScript引擎用尽了各种办法（比如JIT，可以贪吃编译甚至实施重编译）来保证性能最佳。

简单地来说，任何JasvaScript代码片段在执行前都要进行编译（通常就在执行前）。因此，JavaScript编译器首先会对`var a = 2;`这段程序进行编译，然后做好执行它的准备，并且通常马上就会执行它。

### 1.2理解作用域





